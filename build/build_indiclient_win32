#!/bin/bash

# this script builds the indi client libraries for Windows
# the indiclient library dependencies are built with vcpkg [https://github.com/microsoft/vcpkg]

# If VCPKG_ROOT is set, the script will use the packages installed there.
# Otherwise it will use the existing vcpkg dependencies bundeled in the PHD2 source tree.

# usage: build_indiclient_win32 DIRECTORY

set -x
set -e

if [[ ! $1 ]]; then
    echo "Usage: build_indiclient_win32 DIRECTORY" >&1
    exit 1
fi

dir=$1
shift
mkdir -p "$dir"

TOP=$(cd $(dirname "$0")/..; /bin/pwd)
cd "$dir"

if [[ ! $VCPKG_ROOT ]]; then
    if [[ ! -d vcpkg-installed-win32 ]]; then
	unzip -q "$TOP"/thirdparty/vcpkg-installed-win32.zip
    fi
    VCPKG_ROOT=$PWD/vcpkg-installed-win32
fi
PREFIX=$(cygpath -w "$VCPKG_ROOT"/installed/x86-windows)

CMD="/c/Windows/System32/cmd.exe"
CMAKE=$(cygpath -w '/c/Program Files/CMake/bin/cmake.exe')

if [[ ! -d indi ]]; then
    git clone https://github.com/indilib/indi.git
fi
INDIREV=44aaf5d3
(
    cd indi
    git checkout "$INDIREV"
)

mkdir -p indiclient.build indiclient

(
    cd indiclient.build
    cat > bld.bat <<EOF
"$CMAKE" -Wno-dev -G "Visual Studio 17" -A Win32 "-DCMAKE_INSTALL_PREFIX:PATH=../indiclient" "-DCMAKE_PREFIX_PATH=$PREFIX" -DINDI_BUILD_SERVER=OFF -DINDI_BUILD_DRIVERS=OFF -DINDI_BUILD_CLIENT=ON -DINDI_BUILD_QT5_CLIENT=OFF ../indi/libindi
"$CMAKE" --build . --config Release
"$CMAKE" --build . --config Release --target install
"$CMAKE" --build . --config Debug
EOF
    "$CMD" /c bld.bat
)
cp indiclient.build/Debug/indiclient.lib indiclient/lib/indiclientd.lib
rm -f indiclient-${INDIREV}-win32.zip
zip -r indiclient-${INDIREV}-win32.zip indiclient

install -m 0644 indiclient-${INDIREV}-win32.zip "$TOP"/thirdparty/
